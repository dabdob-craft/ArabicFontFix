package com.arabicraft.fontfix;

public class ArabicReshaper {

    private static final int[][] ARABIC_TABLE = {
        {0x0621, 0xFE80, 0xFE80, 0xFE80, 0xFE80}, 
        {0x0622, 0xFE82, 0xFE82, 0xFE82, 0xFE82}, 
        {0x0623, 0xFE84, 0xFE84, 0xFE84, 0xFE84}, 
        {0x0624, 0xFE86, 0xFE86, 0xFE86, 0xFE86}, 
        {0x0625, 0xFE88, 0xFE88, 0xFE88, 0xFE88}, 
        {0x0626, 0xFE8A, 0xFE8B, 0xFE8C, 0xFE89}, 
        {0x0627, 0xFE8E, 0xFE8E, 0xFE8E, 0xFE8D}, 
        {0x0628, 0xFE90, 0xFE91, 0xFE92, 0xFE8F}, 
        {0x0629, 0xFE94, 0xFE94, 0xFE94, 0xFE93}, 
        {0x062A, 0xFE96, 0xFE97, 0xFE98, 0xFE95}, 
        {0x062B, 0xFE9A, 0xFE9B, 0xFE9C, 0xFE99}, 
        {0x062C, 0xFE9E, 0xFE9F, 0xFEA0, 0xFE9D}, 
        {0x062D, 0xFEA2, 0xFEA3, 0xFEA4, 0xFEA1}, 
        {0x062E, 0xFEA6, 0xFEA7, 0xFEA8, 0xFEA5}, 
        {0x062F, 0xFEAA, 0xFEAA, 0xFEAA, 0xFEA9}, 
        {0x0630, 0xFEAC, 0xFEAC, 0xFEAC, 0xFEAB}, 
        {0x0631, 0xFEAE, 0xFEAE, 0xFEAE, 0xFEAD}, 
        {0x0632, 0xFEB0, 0xFEB0, 0xFEB0, 0xFEAF}, 
        {0x0633, 0xFEB2, 0xFEB3, 0xFEB4, 0xFEB1}, 
        {0x0634, 0xFEB6, 0xFEB7, 0xFEB8, 0xFEB5}, 
        {0x0635, 0xFEBA, 0xFEBB, 0xFEBC, 0xFEB9}, 
        {0x0636, 0xFEBE, 0xFEBF, 0xFEC0, 0xFEBD}, 
        {0x0637, 0xFEC2, 0xFEC3, 0xFEC4, 0xFEC1}, 
        {0x0638, 0xFEC6, 0xFEC7, 0xFEC8, 0xFEC5}, 
        {0x0639, 0xFECA, 0xFECB, 0xFECC, 0xFEC9}, 
        {0x063A, 0xFECE, 0xFECF, 0xFED0, 0xFECD}, 
        {0x0641, 0xFED2, 0xFED3, 0xFED4, 0xFED1}, 
        {0x0642, 0xFED6, 0xFED7, 0xFED8, 0xFED5}, 
        {0x0643, 0xFEDA, 0xFEDB, 0xFEDC, 0xFED9}, 
        {0x0644, 0xFEDE, 0xFEDF, 0xFEE0, 0xFEDD}, 
        {0x0645, 0xFEE2, 0xFEE3, 0xFEE4, 0xFEE1}, 
        {0x0646, 0xFEE6, 0xFEE7, 0xFEE8, 0xFEE5}, 
        {0x0647, 0xFEEA, 0xFEEB, 0xFEEC, 0xFEE9}, 
        {0x0648, 0xFEEE, 0xFEEE, 0xFEEE, 0xFEED}, 
        {0x0649, 0xFEF0, 0xFEF0, 0xFEF0, 0xFEEF}, 
        {0x064A, 0xFEF2, 0xFEF3, 0xFEF4, 0xFEF1}  
    };

    public String reshape(String original) {
        if (original == null || original.isEmpty()) {
            return original;
        }

        char[] chars = original.toCharArray();
        int length = chars.length;
        
        char[] shapedChars = new char[length];
        
        for (int i = 0; i < length; i++) {
            char current = chars[i];
            
            int tableIndex = -1;
            if (current >= 0x0621 && current <= 0x064A) {
                tableIndex = current - 0x0621;
            }
            
            if (tableIndex != -1 && tableIndex < ARABIC_TABLE.length) {
                
                int position = 0; 
                
                boolean canConnectPrevious = i > 0 && isConnectable(chars[i - 1]);
                boolean canConnectNext = i < length - 1 && isArabicLetter(chars[i + 1]);
                
                if (canConnectPrevious && canConnectNext) {
                    position = 2; 
                } else if (canConnectPrevious) {
                    position = 3; 
                } else if (canConnectNext) {
                    position = 1; 
                }
                
                shapedChars[i] = (char) ARABIC_TABLE[tableIndex][position + 1]; 
                
            } else {
                shapedChars[i] = current; 
            }
        }
        
        StringBuilder bidi = new StringBuilder(new String(shapedChars));
        return bidi.reverse().toString();
    }
    
    private boolean isConnectable(char c) {
        return !(c == 0x0621 || c == 0x0622 || c == 0x0623 || c == 0x0624 || c == 0x0625 || c == 0x0627 || 
                 c == 0x0629 || c == 0x062F || c == 0x0630 || c == 0x0631 || c == 0x0632 || c == 0x0648 || 
                 c == 0x0649);
    }
    
    private boolean isArabicLetter(char c) {
        return c >= 0x0621 && c <= 0x064A;
    }
}
